# this opens a file named imgs.txt

import subprocess                       # for executing bash code from python
import pandas as pd                     # for working with dataframes
from datetime import date               # for obtaining current date
import json
from pandas import json_normalize

import gc


# define filenames
Downloaded_Report_name = "vulnerability-report-kaptain-main.csv"
Resulting_Report_name = f"vulnerability-report-kaptain-{date.today()}.csv"


# declare variables
Final_Results_df = pd.DataFrame()


# load initial report
Downloaded_Report_df = pd.read_csv(Downloaded_Report_name, header=0)


# clean data
Downloaded_Report_list = Downloaded_Report_df['resource_purl'].drop_duplicates().values.tolist()
Filtered_image_list = [k for k in Downloaded_Report_list if 'mesosphere' in k]
Filtered_image_list = [s.replace("pkg:docker/", "") for s in Filtered_image_list]
Filtered_image_list = [s.replace("@", ":") for s in Filtered_image_list]


def key_lists(d, c = []):
  return [i for a, b in d.items() for i in ([c+[a]] if not isinstance(b, dict) else key_lists(b, c+[a]))]
  
for image in Filtered_image_list[:1]:
    
    Current_img_CVEs_bytes = subprocess.check_output(f"./CVEs-to-CSVs.sh {image.strip()}", shell=True)   # run grype for each image

    Current_img_CVEs_json = json.loads(Current_img_CVEs_bytes.decode('utf8'))

    json_for_print = json.dumps(Current_img_CVEs_json)

    lists = key_lists(Current_img_CVEs_json)        
    
                                                                                        # resulting csv to dataframe

with open("fields-content.json", "w") as textfile:
    json.dump(Current_img_CVEs_json, textfile)

with open("fields-list.txt", "w") as textfile:
    for keys_list in lists:
        textfile.write(".".join(keys_list) + "\n")
